import os
from pathlib import Path
from dotenv import load_dotenv

# Загружаем переменные окружения из .env файла
load_dotenv()

# --- Основные пути ---
BASE_DIR = Path(__file__).resolve().parent
DATA_DIR = BASE_DIR / "data"
RESULTS_DIR = BASE_DIR / "results"
LOGS_DIR = BASE_DIR / "logs"

# Пути к директориям с данными
TEST_SCANS_DIR = DATA_DIR / "test_scans"
PRODUCTION_SCANS_DIR = DATA_DIR / "production_scans"

REHAND_MOCK_TEXTS_DIR = DATA_DIR / "rehand_mock_texts"

# Пути к директориям с результатами
TEST_OUTPUTS_DIR = RESULTS_DIR / "test_outputs"
PRODUCTION_OUTPUT_DIR = RESULTS_DIR / "production_output"

# Файл логов
LOG_FILE = LOGS_DIR / "app.log"

# --- Настройки API ---
YC_API_KEY = os.getenv("YC_API_KEY")
YC_FOLDER_ID = os.getenv("YC_FOLDER_ID")

if not YC_API_KEY or not YC_FOLDER_ID:
    raise ValueError("Необходимо установить YC_API_KEY и YC_FOLDER_ID в .env файле")

# --- Настройки для ТЕСТОВОГО РЕЖИМА ---

# Определения OCR инструментов
OCR_TOOLS = {
    "yandex_vision_simple": {"type": "yandex", "method": "markdown"},
    # "yandex_vision_bbox": {"type": "yandex", "method": "bbox"},
    # "rehand_mock": {"type": "rehand_mock"}
}

# Определения LLM моделей (URI для Yandex Cloud)
LLM_MODELS = {
    # "yandex_gpt_pro": {
    #     "type": "yandex_sdk",
    #     "uri": f"gpt://{YC_FOLDER_ID}/yandexgpt/latest",
    # },
    "qwen3_235b": {
        "type": "openai_compatible",
        "uri": f"gpt://{YC_FOLDER_ID}/qwen3-235b-a22b-fp8/latest",
        "base_url": "https://llm.api.cloud.yandex.net/v1",
    },
    # "gpt_oss_120b": {
    #     "type": "openai_compatible",
    #     "uri": f"gpt://{YC_FOLDER_ID}/gpt-oss-120b/latest",
    #     "base_url": "https://llm.api.cloud.yandex.net/v1",
    # },
}

# Шаблоны промптов (вставьте сюда свои варианты)
# Маркер {{OCR_TEXT}} будет заменен на распознанный текст
PROMPTS = {
    "prompt_1": """
### РОЛЬ ###
Ты — высокоточный реставратор текстов. Твоя единственная цель — с максимальной точностью восстановить оригинальный авторский текст из поврежденного OCR-результата, придерживаясь принципа минимального вмешательства.

### КОНТЕКСТ ###
- **Источник:** Личный дневник женщины (1991-1998, СССР/Россия).
- **Стиль:** "Поток сознания", разговорная, нелитературная речь. **Авторские слова и выражения могут казаться необычными или даже ошибочными — их нужно сохранять.**
- **Входные данные:** "Грязный" OCR-текст с ошибками распознавания и цифровым мусором (повторяющиеся бессмысленные фразы).

### ЗАДАЧА ###
Проведи скрупулезную чистку и восстановление текста. Результат представь в чистом Markdown-формате.

### ГЛАВНЫЙ ПРИНЦИП: МИНИМАЛЬНОЕ ВМЕШАТЕЛЬСТВО ###
Твоя главная задача — не "улучшить" текст, а вернуть его к тому виду, который был в рукописи. **Если сомневаешься — не исправляй.** Лучше оставить ошибку OCR, чем выдумать новое слово.

### КЛЮЧЕВЫЕ ПРАВИЛА ###

#### ✓ ЧТО НУЖНО ДЕЛАТЬ:
1.  **Агрессивно удалять мусор:** Идентифицируй и полностью удаляй бессмысленные, повторяющиеся фразы, которые являются очевидными артефактами OCR.
2.  **Корректировать только очевидные опечатки:** Исправляй только те ошибки, где замена 1-2 букв очевидно восстанавливает слово (`толны` → `толпы`, `двемный` → `дымный`). **Исправление должно быть основано на буквенном сходстве, а не на семантической догадке.**
3.  **Соединять разорванные предложения:** Если артефакт или перенос строки разрывает предложение, соедини его части.
4.  **Форматировать абзацы:** Каждый логический абзац должен быть отделен от следующего ровно одной пустой строкой. Убирай все лишние одиночные переносы строк.

#### ✗ ЧЕГО КАТЕГОРИЧЕСКИ НЕЛЬЗЯ ДЕЛАТЬ:
❌ **ЗАПРЕЩЕНЫ СМЫСЛОВЫЕ ЗАМЕНЫ:** Никогда не заменяй распознанное слово на синоним, антоним или семантически близкое слово, даже если оно кажется более подходящим по контексту. Если OCR распознал `телохранители`, в результате должны быть `телохранители`, а не `охранники` или `жёлто-коричневые`.
❌ **НЕ "УЛУЧШАТЬ" СТИЛЬ:** Сохраняй все авторские особенности речи, даже если они кажутся стилистически несовершенными.
❌ **НЕ ДОБАВЛЯТЬ ИНФОРМАЦИЮ:** Не вставляй слова или знаки препинания (например, кавычки для `«ура»`), которых нет в исходном тексте OCR.
❌ **ПРИ НЕУВЕРЕННОСТИ — ИСПОЛЬЗУЙ ЗАГЛУШКУ:** Если слово искажено настолько, что его невозможно восстановить с высокой долей уверенности (более 95%), используй маркер **[неразборчиво]** вместо своей догадки.

### ПРИМЕРЫ ПРАВИЛЬНОЙ ОБРАБОТКИ ###

| Входной "грязный" текст                                  | ✅ Правильный выход                                     | ❌ Неправильный выход                                                    |
| -------------------------------------------------------- | ------------------------------------------------------ | ----------------------------------------------------------------------- |
| `...неистовство толны, ревизская сказка или как там`      | `...неистовство толпы, или как там`                     | ---                                                                     |
| `...бандой желохранителей. А женерь ворнуем:`             | `...бандой телохранителей. А теперь воркуем:`           | `...бандой жёлто-коричневых. А теперь воркуем:` (Смысловая замена)         |
| `...пританцо вывать перед народ ом 4.`                    | `...пританцовывать перед народом.`                      | `...пританцовывать перед «народом».` (Добавление информации)              |
| `...поведение жолны любо жеетствующих не могут`            | `...поведение толпы любопытствующих не могут`            | `...поведение толпы зевак не могут` (Более сильное изменение)            |
| `...по рытвинам и ухабам, что свойственно нашей руххклой` | `...по рытвинам и ухабам, что свойственно нашей [неразборчиво]` | `...по рытвинам и ухабам, что свойственно нашей русской` (Необоснованная догадка) |


### ТЕКСТ ДЛЯ ОБРАБОТКИ ###
{{OCR_TEXT}}
"""
}

# --- Настройки для РАБОЧЕГО РЕЖИМА ---
# Выберите лучшую комбинацию после тестов
PRODUCTION_OCR_TOOL = "yandex_vision_simple" # Например, "yandex_vision_bbox"
PRODUCTION_LLM_MODEL = "qwen3_235b"        # Например, "qwen3_235b"
PRODUCTION_PROMPT = "prompt_1"             # Например, "prompt_2"
