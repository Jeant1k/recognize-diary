import os
import re
import base64
import requests
import time
from docx import Document
from docx.shared import Pt, Inches
from dotenv import load_dotenv
import openai

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
load_dotenv()

# –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
CONFIG = {
    "API_KEY": os.getenv("YC_API_KEY"),
    "FOLDER_ID": os.getenv("YC_FOLDER_ID"),
    "IMAGE_DIR": "scans_for_test",
    "OUTPUT_DOCX_NAME": "diary.docx",
    "GPT_MODEL_URI": "gpt://{folder_id}/qwen3-235b-a22b-fp8/latest",
    "OPENAI_BASE_URL": "https://llm.api.cloud.yandex.net/v1",
    "DEBUG": os.getenv("DEBUG_MODE", "false").lower() in ('true', '1', 't', 'yes'),
    "DEBUG_DIR": "debug_output"
}

# --- –ü–†–û–ú–ü–¢ –î–õ–Ø LLM ---
# –≠—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞
SYSTEM_PROMPT = """
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç-—Ä–µ—Å—Ç–∞–≤—Ä–∞—Ç–æ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø–æ—Å–ª–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (OCR) —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Å–æ–≤–µ—Ç—Å–∫–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞. –¢–µ–∫—Å—Ç –∏–º–µ–µ—Ç –æ–≥—Ä–æ–º–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å. –¢–≤–æ—è —Ä–∞–±–æ—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–µ–¥–µ–ª—å–Ω–æ–π –∞–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç–∏ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

**–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å:** –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –∞–≤—Ç–æ—Ä—Å–∫–∏–π —Ç–µ–∫—Å—Ç, –∏—Å–ø—Ä–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –∏ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏ –æ—à–∏–±–∫–∏ OCR, –∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –≤ Markdown.

**–ê–≤—Ç–æ—Ä –¥–Ω–µ–≤–Ω–∏–∫–∞ ‚Äî –∂–µ–Ω—â–∏–Ω–∞.** –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –æ–∫–æ–Ω—á–∞–Ω–∏–π –≥–ª–∞–≥–æ–ª–æ–≤ –≤ –ø—Ä–æ—à–µ–¥—à–µ–º –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—è —Ö–æ–¥–∏–ª–∞", –∞ –Ω–µ "—è —Ö–æ–¥–∏–ª"), –µ—Å–ª–∏ OCR –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª –∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–ò–µ—Ä–∞—Ä—Ö–∏—è –ø—Ä–∞–≤–∏–ª:**

**–£—Ä–æ–≤–µ–Ω—å 1: –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –ó–∞–ø—Ä–µ—â–µ–Ω–æ (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ê–≤—Ç–æ—Ä—Å–∫–æ–≥–æ –°—Ç–∏–ª—è):**
1.  **–ù–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π –∏ –Ω–µ "—É–ª—É—á—à–∞–π" —Ç–µ–∫—Å—Ç.** –°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ –∞–≤—Ç–æ—Ä—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ –∏ —Å—Ç–∏–ª—å "–ø–æ—Ç–æ–∫–∞ —Å–æ–∑–Ω–∞–Ω–∏—è". –ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–Ω–æ "–ø–æ—à–ª–∏ –º—ã –≥—É–ª—è—Ç–∏", –æ—Å—Ç–∞–≤–ª—è–π "–ø–æ—à–ª–∏ –º—ã –≥—É–ª—è—Ç–∏".
2.  **–ù–µ –∏—Å–ø—Ä–∞–≤–ª—è–π –≥—Ä–∞–º–º–∞—Ç–∏–∫—É –∏ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –∞–≤—Ç–æ—Ä–∞.** –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –Ω–æ—Ä–º—ã, –¥–∏–∞–ª–µ–∫—Ç–∏–∑–º—ã, –∞–≤—Ç–æ—Ä—Å–∫–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏–ª–∏ –æ—à–∏–±–∫–∏ ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏. –ù–µ —Ç—Ä–æ–≥–∞–π –∏—Ö.
3.  **–ù–µ –¥–æ–¥—É–º—ã–≤–∞–π —Å–º—ã—Å–ª.** –ï—Å–ª–∏ —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –Ω–µ—á–∏—Ç–∞–µ–º–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–µ –ø—ã—Ç–∞–π—Å—è –µ—ë –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ —Å–º—ã—Å–ª—É. –û—Å—Ç–∞–≤–ª—è–π –∫–∞–∫ –µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—Ä#—à–ª–æ—Å—å" –∏–ª–∏ "–Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–µ —Å–ª–æ–≤–æ").

**–£—Ä–æ–≤–µ–Ω—å 2: –†–∞–∑—Ä–µ—à–µ–Ω–Ω–∞—è –†–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –û—à–∏–±–æ–∫ OCR):**
–≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –º–æ–∂–µ—à—å –∏ –¥–æ–ª–∂–µ–Ω –≤–Ω–æ—Å–∏—Ç—å.
1.  **–°–æ–µ–¥–∏–Ω—è–π —Ä–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞:** OCR —á–∞—Å—Ç–æ —Ä–≤–µ—Ç —Å–ª–æ–≤–∞ –Ω–∞ —á–∞—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Å–ª–æ –≤–æ", "–ø–µ—Ä–µ –∂–∏–≤–∞–Ω–∏–µ"). –ê–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–æ–µ–¥–∏–Ω—è–π –∏—Ö –≤ "—Å–ª–æ–≤–æ", "–ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–µ".
2.  **–ò—Å–ø—Ä–∞–≤–ª—è–π –æ—á–µ–≤–∏–¥–Ω—ã–µ –æ–ø–µ—á–∞—Ç–∫–∏ OCR:** –ï—Å–ª–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∞ 99% —è—Å–Ω–æ, —á—Ç–æ OCR –¥–æ–ø—É—Å—Ç–∏–ª –æ—à–∏–±–∫—É, –∏—Å–ø—Ä–∞–≤—å –µ—ë.
    *   –ü—Ä–∏–º–µ—Ä: "—É–¥–Ω–∞—Ç—å –ø—Ä–∞–≤–¥—É" ‚Üí "—É–∑–Ω–∞—Ç—å –ø—Ä–∞–≤–¥—É".
    *   –ü—Ä–∏–º–µ—Ä: "–≤ 80% –º–µ–Ω—è –ø–æ–ø—Ä–æ—Å–∏–ª–∏" ‚Üí "–≤ 80-—Ö –º–µ–Ω—è –ø–æ–ø—Ä–æ—Å–∏–ª–∏".
3.  **–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞:** OCR –º–æ–∂–µ—Ç –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–Ω–µ—Ü —Å–ª–æ–≤–∞ –∏–∑-–∑–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏.
    *   –ü—Ä–∏–º–µ—Ä: "–ø–µ—Ä–µ–¥ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ–º —Å–æ—é–∑–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–æ-" ‚Üí "–ø–µ—Ä–µ–¥ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ–º —Å–æ—é–∑–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞".
4.  **–£—á–∏—Ç—ã–≤–∞–π –ø–æ–ª –∞–≤—Ç–æ—Ä–∞:** –ï—Å–ª–∏ –≥–ª–∞–≥–æ–ª –≤ –ø—Ä–æ—à–µ–¥—à–µ–º –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—è –ø–æ–¥–≤–µ—Ä–≥–∞–ª—Å—è"), –∏—Å–ø–æ–ª—å–∑—É–π –∂–µ–Ω—Å–∫–∏–π —Ä–æ–¥ ("—è –ø–æ–¥–≤–µ—Ä–≥–∞–ª–∞—Å—å").

**–£—Ä–æ–≤–µ–Ω—å 3: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1.  **–ê–±–∑–∞—Ü—ã:** –ì—Ä—É–ø–ø–∏—Ä—É–π –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∞–±–∑–∞—Ü—ã, –∫–∞–∫ —ç—Ç–æ –ø—Ä–∏–Ω—è—Ç–æ –≤ –¥–Ω–µ–≤–Ω–∏–∫–∞—Ö. –ù–µ —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã–π –∞–±–∑–∞—Ü –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –°—Ç–∞—Ä–∞–π—Å—è —Å–ª–µ–¥–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –µ—Å–ª–∏ –æ–Ω–∞ —É–≥–∞–¥—ã–≤–∞–µ—Ç—Å—è.
2.  **–î–∞—Ç—ã –∏ –ø–æ–¥–ø–∏—Å–∏:** –î–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "21 –∏—é–Ω—è 91 –≥.") ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞, –æ–±—ã—á–Ω–æ –≤ –∫–æ–Ω—Ü–µ –∏–ª–∏ –Ω–∞—á–∞–ª–µ –∑–∞–ø–∏—Å–∏. **–ù–µ –¥–µ–ª–∞–π –∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏!** –û—Å—Ç–∞–≤–ª—è–π –∏—Ö –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ –∏–ª–∏ –Ω–∞—á–∞–ª–µ –∞–±–∑–∞—Ü–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π.
3.  **–ó–∞–≥–æ–ª–æ–≤–∫–∏:** –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ Markdown (`##`) —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—á–µ–Ω—å —è–≤–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –≥–ª–∞–≤ –∏–ª–∏ —Ä–∞–∑–¥–µ–ª–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å. –í 99% —Å–ª—É—á–∞–µ–≤ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ –∏—Ö –Ω–µ –±—É–¥–µ—Ç.
4.  **–¶–∏—Ç–∞—Ç—ã:** –ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã –∏–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –æ—Ñ–æ—Ä–º–ª—è–π –∫–∞–∫ —Ü–∏—Ç–∞—Ç—ã Markdown (`> `).
5.  **–í—ã–≤–æ–¥ ‚Äî —Ç–æ–ª—å–∫–æ Markdown.** –ù–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –æ—Ç —Ç–µ–±—è.

---
**–ü—Ä–∏–º–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:**

**–í—Ö–æ–¥–Ω–æ–π —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç:**
"–ù–∞–¥–æ –±—ã–ª–æ —É–¥–Ω–∞—Ç—å –ø—Ä–∞–≤–¥—É. –ü—Ä–æ—à–ª–æ –Ω–µ —Ç–∞–∫ —É–∂ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å —Ç–µ—Ö –ø–æ—Ä, –∏ –≤–æ—Ç —Å–µ–π—á–∞—Å, –≤ –ø—Ä–µ–¥—Ä—ã–Ω–æ—á- –Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∞, –∫–æ–≥–¥–∞ —Å—Ç–æ–ª—å–∫–æ –∏–¥–µ–∞–ª–æ–≤ –ø–æ–ª–æ–º–∞–ª–æ—Å—å –≤ –Ω–∞—Å, —è —Å —É–∂–∞—Å–æ–º –≤—Å–ø–æ–º–∏–Ω–∞—é –º–æ–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ–µ –Ω–µ–≥–æ–¥–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç—á–∞—è–Ω–∏–µ. –ò –º—ã –≤–µ—Ä—É–µ–º! –ú—ã –ø—Ä–∏–≤—ã–∫–ª–∏ –≤–µ—Ä–æ–≤–∞—Ç—å! —è –Ω–µ –æ —Ç–æ–º, —á—Ç–æ –ø–æ–¥–≤–µ—Ä–≥–∞—é —Å–æ–º–Ω–µ–Ω–∏—é –Ω–æ–≤—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏. —è –æ —Ç–æ–º, —á—Ç–æ —è —Å–Ω–æ–≤–∞ –ø–æ–¥–≤–µ—Ä–≥–∞–ª—Å—è. 21–∏—é–Ω—è91 –≥."

**–¢–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–≤—ã–≤–æ–¥ –≤ Markdown):**
–ü—Ä–æ—à–ª–æ –Ω–µ —Ç–∞–∫ —É–∂ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å —Ç–µ—Ö –ø–æ—Ä, –∏ –≤–æ—Ç —Å–µ–π—á–∞—Å, –≤ "–ø—Ä–µ–¥—Ä—ã–Ω–æ—á–Ω—ã–µ" –≤—Ä–µ–º–µ–Ω–∞, –∫–æ–≥–¥–∞ —Å—Ç–æ–ª—å–∫–æ –∏–¥–µ–∞–ª–æ–≤ –ø–æ–ª–æ–º–∞–ª–æ—Å—å –≤ –Ω–∞—Å, —è —Å —É–∂–∞—Å–æ–º –≤—Å–ø–æ–º–∏–Ω–∞—é –º–æ–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ–µ –Ω–µ–≥–æ–¥–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç—á–∞—è–Ω–∏–µ. –ò –º—ã –≤–µ—Ä—É–µ–º! –ú—ã –ø—Ä–∏–≤—ã–∫–ª–∏ –≤–µ—Ä–æ–≤–∞—Ç—å!

–Ø –Ω–µ –æ —Ç–æ–º, —á—Ç–æ –ø–æ–¥–≤–µ—Ä–≥–∞—é —Å–æ–º–Ω–µ–Ω–∏—é –Ω–æ–≤—ã–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏. –Ø –æ —Ç–æ–º, —á—Ç–æ —è —Å–Ω–æ–≤–∞ –ø–æ–¥–≤–µ—Ä–≥–∞–ª–∞—Å—å.

–ù–∞–¥–æ –±—ã–ª–æ —É–∑–Ω–∞—Ç—å –ø—Ä–∞–≤–¥—É.

21 –∏—é–Ω—è 91 –≥.
"""

def check_config():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–ª—é—á–µ–π –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."""
    if not CONFIG["API_KEY"] or not CONFIG["FOLDER_ID"]:
        print("!!! –û–®–ò–ë–ö–ê: –ù–µ –Ω–∞–π–¥–µ–Ω—ã YC_API_KEY –∏–ª–∏ YC_FOLDER_ID.")
        print("!!! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.")
        return False
    if not os.path.isdir(CONFIG["IMAGE_DIR"]):
        print(f"!!! –û–®–ò–ë–ö–ê: –ü–∞–ø–∫–∞ '{CONFIG['IMAGE_DIR']}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        print("!!! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ –µ–µ –∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ —Ç—É–¥–∞ —Ñ–∞–π–ª—ã —Å–∫–∞–Ω–æ–≤.")
        return False
    return True

def natural_sort_key(s: str) -> list:
    """–ö–ª—é—á –¥–ª—è "–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π" —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫ —Ç–∏–ø–∞ '10.jpg' > '2.jpg'."""
    return [int(text) if text.isdigit() else text.lower() for text in re.split(r'(\d+)', s)]

def encode_image_to_base64(filepath: str) -> str:
    """–ö–æ–¥–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫—É Base64."""
    with open(filepath, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode('utf-8')

def get_raw_text_from_ocr(base64_content: str) -> str | None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ Yandex Vision OCR –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç."""
    url = "https://ocr.api.cloud.yandex.net/ocr/v1/recognizeText"
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Api-Key {CONFIG['API_KEY']}",
        "x-folder-id": CONFIG["FOLDER_ID"],
    }
    body = {
        "mimeType": "JPEG",
        "languageCodes": ["ru", "en", "de"],
        "model": "handwritten",
        "content": base64_content
    }

    try:
        response = requests.post(url, headers=headers, json=body, timeout=180)
        response.raise_for_status()
        result = response.json()
        full_text = result.get('result', {}).get('textAnnotation', {}).get('fullText', '')
        return full_text
    except requests.exceptions.HTTPError as e:
        print(f"  [–û—à–∏–±–∫–∞ OCR] HTTP-–æ—à–∏–±–∫–∞: {e.response.status_code}. –û—Ç–≤–µ—Ç: {e.response.text}")
        return None
    except requests.exceptions.RequestException as e:
        print(f"  [–û—à–∏–±–∫–∞ OCR] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É OCR: {e}")
        return None

def format_text_with_gpt(raw_text: str) -> str | None:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –≤ LLM —á–µ—Ä–µ–∑ OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API Yandex.Cloud
    –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    print(f"    - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI –¥–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ Yandex.Cloud...")
    try:
        client = openai.OpenAI(
            api_key=CONFIG["API_KEY"],
            base_url=CONFIG["OPENAI_BASE_URL"],
            project=CONFIG["FOLDER_ID"]
        )

        model_uri = CONFIG["GPT_MODEL_URI"].format(folder_id=CONFIG["FOLDER_ID"])
        print(f"    - –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –º–æ–¥–µ–ª–∏: {model_uri}")
        
        response = client.chat.completions.create(
            model=model_uri,
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": raw_text}
            ],
            temperature=0.0,
            max_tokens=8000,
            stream=False
        )
        
        formatted_text = response.choices[0].message.content
        return formatted_text

    except openai.APIError as e:
        print(f"  [–û—à–∏–±–∫–∞ GPT/API] –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: {e.__class__.__name__} - {e}")
        return None
    except Exception as e:
        print(f"  [–û—à–∏–±–∫–∞ GPT/–ö–ª–∏–µ–Ω—Ç] –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e.__class__.__name__} - {e}")
        return None

def add_markdown_to_document(doc: Document, markdown_text: str):
    """–ü–∞—Ä—Å–∏—Ç Markdown –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ Word –¥–æ–∫—É–º–µ–Ω—Ç."""
    for line in markdown_text.split('\n'):
        line_stripped = line.strip()
        if not line_stripped:
            doc.add_paragraph()
            continue
        
        if line.startswith('## '):
            doc.add_heading(line.lstrip('## ').strip(), level=2)
        elif line.startswith('# '):
            doc.add_heading(line.lstrip('# ').strip(), level=1)
        elif line.startswith('> '):
            p = doc.add_paragraph(style='Intense Quote')
            p.add_run(line.lstrip('> ').strip())
        else:
            doc.add_paragraph(line)

def main():
    if not check_config():
        return
    
    if CONFIG["DEBUG"]:
        os.makedirs(CONFIG["DEBUG_DIR"], exist_ok=True)
        print("-" * 40)
        print(f"*** –†–ï–ñ–ò–ú –û–¢–õ–ê–î–ö–ò –í–ö–õ–Æ–ß–ï–ù. –°—ã—Ä—ã–µ OCR —Ç–µ–∫—Å—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫—É '{CONFIG['DEBUG_DIR']}'. ***")
        print("-" * 40)

    image_files = [f for f in os.listdir(CONFIG["IMAGE_DIR"]) if f.lower().endswith(('.jpg', '.jpeg', '.png'))]
    image_files.sort(key=natural_sort_key)
        
    if not image_files:
        print(f"!!! –û–®–ò–ë–ö–ê: –í –ø–∞–ø–∫–µ '{CONFIG['IMAGE_DIR']}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (jpg, jpeg, png).")
        return

    print(f"–ù–∞–π–¥–µ–Ω–æ {len(image_files)} —Å—Ç—Ä–∞–Ω–∏—Ü. –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...")
    model_display_name = CONFIG['GPT_MODEL_URI'].split('/')[-2]
    print(f"–ú–æ–¥–µ–ª—å –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {model_display_name}")

    doc = Document()
    style = doc.styles['Normal']
    font = style.font
    font.name = 'Times New Roman'
    font.size = Pt(12)

    total_files = len(image_files)
    start_time = time.time()

    for i, filename in enumerate(image_files, 1):
        page_number_match = re.search(r'(\d+)', os.path.splitext(filename)[0])
        page_label = page_number_match.group(1) if page_number_match else filename

        print(f"\n[{i}/{total_files}] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {filename}")
        doc.add_heading(f'–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page_label}', level=1)
        filepath = os.path.join(CONFIG["IMAGE_DIR"], filename)
        
        print("  -> –®–∞–≥ 1: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä—É–∫–æ–ø–∏—Å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (OCR)...")
        base64_content = encode_image_to_base64(filepath)
        raw_text = get_raw_text_from_ocr(base64_content)

        if CONFIG["DEBUG"] and raw_text and raw_text.strip():
            debug_filename = f"raw_{page_label}.txt"
            debug_filepath = os.path.join(CONFIG["DEBUG_DIR"], debug_filename)
            try:
                with open(debug_filepath, 'w', encoding='utf-8') as f:
                    f.write(raw_text)
                print(f"    - [DEBUG] –°—ã—Ä–æ–π —Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {debug_filepath}")
            except IOError as e:
                print(f"    - [DEBUG –û–®–ò–ë–ö–ê] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç: {e}")
        
        if not raw_text or not raw_text.strip():
            print("  [–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ] –¢–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç.")
            p = doc.add_paragraph()
            p.add_run("[–ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω]").italic = True
            if i < total_files: doc.add_page_break()
            continue

        print(f"  -> –®–∞–≥ 2: –†–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ ({len(raw_text)} —Å–∏–º–≤.)...")
        formatted_text = format_text_with_gpt(raw_text)

        if formatted_text:
            print("  -> –®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ Word –¥–æ–∫—É–º–µ–Ω—Ç...")
            add_markdown_to_document(doc, formatted_text)
        else:
            print("  [–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç. –í—Å—Ç–∞–≤–ª—è—é —Å—ã—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç OCR.")
            doc.add_heading("–°—ã—Ä–æ–π —Ç–µ–∫—Å—Ç —Å OCR (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å)", level=3)
            p = doc.add_paragraph()
            p.add_run(raw_text).italic = True
        
        if i < total_files:
            doc.add_page_break()

    print("-" * 40)
    print("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞...")
    try:
        doc.save(CONFIG["OUTPUT_DOCX_NAME"])
        end_time = time.time()
        total_time = end_time - start_time
        print("-" * 40)
        print("üéâ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        print(f"–ò—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫: {CONFIG['OUTPUT_DOCX_NAME']}")
        print(f"–ó–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è: {total_time:.2f} —Å–µ–∫—É–Ω–¥ ({total_time/60:.2f} –º–∏–Ω—É—Ç).")
    except Exception as e:
        print(f"!!! –û–®–ò–ë–ö–ê –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")
        print(f"!!! –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª {CONFIG['OUTPUT_DOCX_NAME']} –æ—Ç–∫—Ä—ã—Ç –≤ –¥—Ä—É–≥–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ. –ó–∞–∫—Ä–æ–π—Ç–µ –µ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")


if __name__ == '__main__':
    main()
